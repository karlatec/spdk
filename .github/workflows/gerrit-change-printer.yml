name: Print Gerrit patchset data

on:
  workflow_call:
    inputs:
      patchset_ref:
        required: false
        default: ''
        type: string
      patchset_rev:
        required: false
        default: ''
        type: string
      patchset_num:
        required: false
        default: ''
        type: string
      change_num:
        required: false
        default: ''
        type: string

jobs:
  print-patchset:
    runs-on: ubuntu-latest
    steps:
      - name: Print patchset ref & revision
        run: |
          echo "Webhook Payload - patch set ref & hash:"
          echo "${{ inputs.patchset_ref }}"
          echo "${{ inputs.patchset_rev }}"

  report:
    runs-on: ubuntu-latest
    needs:
      - print-patchset
    steps:
      - name: Report results
        run: |
          set -e

          VOTE=-1
          if [[ "${{ needs.print-patchset.result }}" == "success" ]]; then
            VOTE=1
          fi

          # For demonstration purposes, as not to set any actual vote and only comment.
          VOTE=0

          curl -X POST https://review.spdk.io/gerrit/a/changes/"${{ inputs.change_num }}"/revisions/"${{ inputs.patchset_num }}"/review \
          --user "${{ secrets.GERRIT_UNAME }}:${{ secrets.GERRIT_PASSWD }}" \
          --header "Content-Type: application/json" \
          --data "{ 'message': '$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID', 'labels': {'Verified': $VOTE}}" \
          --fail-with-body
